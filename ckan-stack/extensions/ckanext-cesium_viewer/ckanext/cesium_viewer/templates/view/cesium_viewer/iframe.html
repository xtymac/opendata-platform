{% set cfg = cesium_viewer %}
{% if cfg.error %}
  <div class="alert alert-danger">
    {{ cfg.error }}
  </div>
{% elif h.cesium_asset_is_html(resource) %}
  <div class="cesium-viewer-embed">
    <iframe
      src="{{ cfg.resource_url }}"
      class="cesium-viewer-iframe"
      allowfullscreen="{{ 'allowfullscreen' if cfg.allow_fullscreen else '' }}"
      loading="lazy"
      title="3D Cesium Viewer"
    ></iframe>
  </div>
{% elif not cfg.tileset_url %}
  <div class="alert alert-warning">
    {{ _('No tileset URL available for this resource view.') }}
  </div>
{% else %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cesium@1.121/Build/Cesium/Widgets/widgets.css">
  <style>
    .cesium-tileset-container {
      width: 100%;
      height: 600px;
    }
  </style>
  <div id="cesium-tileset" class="cesium-tileset-container"></div>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.121/Build/Cesium/Cesium.js"></script>
  <script type="text/javascript">
    (function () {
      if (!window.Cesium) {
        console.error('Cesium library failed to load');
        return;
      }

      Cesium.Ion.defaultAccessToken = '';
      var viewer = new Cesium.Viewer('cesium-tileset', {
        animation: false,
        timeline: false,
        geocoder: false,
        homeButton: true,
        sceneModePicker: true,
        baseLayerPicker: true,
        navigationHelpButton: false,
        infoBox: true,
        fullscreenButton: {{ 'true' if cfg.allow_fullscreen else 'false' }}
      });

      viewer.imageryLayers.removeAll();
      viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
        url: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
        credit: 'Â© OpenStreetMap contributors'
      }));
      viewer.scene.primitives.removeAll();

      var tilesetUrl = '{{ cfg.tileset_url }}';
      if (!tilesetUrl) {
        console.error('No tileset URL configured for Cesium viewer');
        return;
      }

      Cesium.Cesium3DTileset.fromUrl(tilesetUrl).then(function (tileset) {
        viewer.scene.primitives.add(tileset);
        viewer.scene.camera.flyToBoundingSphere(tileset.boundingSphere, {
          duration: 0.0
        });
      }).catch(function (error) {
        console.error('Failed to load Cesium tileset', error);
      });
    })();
  </script>
{% endif %}
